<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // âœ… Set User Data from Telegram
    document.getElementById("user_id").value = tg.initDataUnsafe?.user?.id || "N/A";
    document.getElementById("first_name").value = tg.initDataUnsafe?.user?.first_name || "N/A";
    document.getElementById("last_name").value = tg.initDataUnsafe?.user?.last_name || "N/A";
    document.getElementById("username").value = tg.initDataUnsafe?.user?.username ? "@" + tg.initDataUnsafe?.user?.username : "N/A";
    document.getElementById("language").value = tg.initDataUnsafe?.user?.language_code || "N/A";

    function updateForm() {
        let formType = document.getElementById("formType").value;
        let extraFields = document.getElementById("extraFields");
        extraFields.innerHTML = "";

        let fieldDefinitions = {
            "airport": [
                "Flight Number", "Pickup & Destination Address",
                { label: "Service Level", type: "radio", options: ["æ™®é€š", "VIP", "è¶…çº§ VIP"] },
                { label: "Upgrade Service", type: "checkbox", options: ["è¡ŒæååŠ©", "å»¶é•¿ç­‰å€™æ—¶é—´", "å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰"] }
            ],
            "hotel": [
                "Full Name", "Contact Info", "Check-in & Check-out Date",
                { label: "Room Type", type: "radio", options: ["å•äººæˆ¿", "åŒäººæˆ¿", "è±ªåæˆ¿", "å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰"] },
                { label: "Payment Method", type: "radio", options: ["ç°é‡‘", "ä¿¡ç”¨å¡", "å¾®ä¿¡æ”¯ä»˜", "æ”¯ä»˜å®"] },
                { label: "Special Requests", type: "checkbox", options: ["æ— çƒŸæˆ¿", "é«˜æ¥¼å±‚", "åŠ åºŠ", "å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰"] }
            ],
            "visa": [
                "Name (Pinyin)", "DOB & Nationality", "Passport Number", "Passport Expiry Date",
                { label: "Visa Type", type: "radio", options: ["æ—…æ¸¸ç­¾", "å•†åŠ¡ç­¾", "å­¦ç”Ÿç­¾", "å·¥ä½œç­¾"] },
                "Destination Country", "Entry Date & Duration",
                { label: "Required Documents", type: "checkbox", options: ["æŠ¤ç…§æ‰«æä»¶", "ç…§ç‰‡", "é“¶è¡Œæµæ°´", "é‚€è¯·å‡½", "å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰"] },
                "Emergency Contact", 
                { label: "Payment Method", type: "radio", options: ["ç°é‡‘", "é“¶è¡Œè½¬è´¦", "å¾®ä¿¡æ”¯ä»˜", "æ”¯ä»˜å®"] }
            ]
        };

        if (fieldDefinitions[formType]) {
            fieldDefinitions[formType].forEach(field => {
                let label = document.createElement("label");

                if (typeof field === "string") {
                    label.textContent = field + ":";
                    let input = document.createElement("input");
                    input.type = "text";
                    input.id = field.replace(/\s+/g, "_").toLowerCase();
                    input.required = true;
                    extraFields.appendChild(label);
                    extraFields.appendChild(input);
                } else {
                    label.textContent = field.label + ":";
                    extraFields.appendChild(label);

                    field.options.forEach(option => {
                        let optionContainer = document.createElement("div");
                        let input = document.createElement("input");
                        input.type = field.type;
                        input.name = field.label.replace(/\s+/g, "_").toLowerCase();
                        input.value = option;
                        input.id = input.name + "_" + option.replace(/\s+/g, "_").toLowerCase();

                        let optionLabel = document.createElement("label");
                        optionLabel.htmlFor = input.id;
                        optionLabel.textContent = option;

                        optionContainer.appendChild(input);
                        optionContainer.appendChild(optionLabel);
                        extraFields.appendChild(optionContainer);
                    });
                }
            });
        }
    }

    function escapeMarkdown(text) {
        if (!text) return "N/A";
        return text.replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&'); // Escape special characters
    }

    function submitForm() {
        const BOT_TOKEN = "7100869336:AAGcqGRUKa1Q__gLmDVWJCM4aZQcD-1K_eg";
        const ADMIN_ID = "8101143576";

        let formData = {
            user_id: document.getElementById("user_id").value,
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            username: document.getElementById("username").value,
            language: document.getElementById("language").value,
            date: document.getElementById("date")?.value || "N/A",
            number: document.getElementById("number")?.value || "N/A",
            form_type: document.getElementById("formType").value
        };

        let extraFields = document.getElementById("extraFields").querySelectorAll("input");
        extraFields.forEach(input => {
            if (input.type === "radio" || input.type === "checkbox") {
                if (input.checked) {
                    formData[input.name] = (formData[input.name] || []) .concat(input.value);
                }
            } else {
                formData[input.id] = input.value;
            }
        });

        let message = `ğŸ“‹ *New Form Submission*\n\n`;
        message += `ğŸ†” *ç”¨æˆ· ID:* \`${escapeMarkdown(formData.user_id)}\`\n`;
        message += `ğŸ‘¤ *ç”¨æˆ·å§“å:* \`${escapeMarkdown(formData.first_name)} ${escapeMarkdown(formData.last_name)}\`\n`;
        message += `ğŸ“„ *é€‰æ‹©ç±»å‹:* \`${escapeMarkdown(formData.form_type)}\`\n`;
        message += `ğŸ“… *æ—¥æœŸ:* \`${escapeMarkdown(formData.date)}\`\n`;
        message += `ğŸ“ *è”ç³»æ–¹å¼:* \`${escapeMarkdown(formData.number)}\`\n`;

        for (let key in formData) {
            if (!["user_id", "first_name", "last_name", "form_type", "date", "number"].includes(key)) {
                if (Array.isArray(formData[key])) {
                    message += `ğŸ”¹ *${escapeMarkdown(key)}:* \`${escapeMarkdown(formData[key].join(", "))}\`\n`;
                } else {
                    message += `ğŸ”¹ *${escapeMarkdown(key)}:* \`${escapeMarkdown(formData[key])}\`\n`;
                }
            }
        }

        // âœ… Send Data Directly to Admin via Telegram API
        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                chat_id: ADMIN_ID,
                text: message,
                parse_mode: "MarkdownV2"
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("âœ… Telegram API Response:", data);
            if (data.ok) {
                alert("âœ… Form submitted successfully!");
                tg.close();
            } else {
                alert("âŒ Telegram API Error: " + data.description);
            }
        })
        .catch(error => {
            console.error("âŒ Fetch Error:", error);
            alert("âŒ Submission failed. Please check the console.");
        });
    }
</script>
