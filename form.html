<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // ✅ Set User Data from Telegram
    document.getElementById("user_id").value = tg.initDataUnsafe?.user?.id || "N/A";
    document.getElementById("first_name").value = tg.initDataUnsafe?.user?.first_name || "N/A";
    document.getElementById("last_name").value = tg.initDataUnsafe?.user?.last_name || "N/A";
    document.getElementById("username").value = tg.initDataUnsafe?.user?.username ? "@" + tg.initDataUnsafe?.user?.username : "N/A";
    document.getElementById("language").value = tg.initDataUnsafe?.user?.language_code || "N/A";

    function updateForm() {
        let formType = document.getElementById("formType").value;
        let extraFields = document.getElementById("extraFields");
        extraFields.innerHTML = "";

        let fieldDefinitions = {
            "airport": [
                "Flight Number", "Pickup & Destination Address",
                { label: "Service Level", type: "radio", options: ["普通", "VIP", "超级 VIP"] },
                { label: "Upgrade Service", type: "checkbox", options: ["行李协助", "延长等候时间", "其他（请填写）"] }
            ],
            "hotel": [
                "Full Name", "Contact Info", "Check-in & Check-out Date",
                { label: "Room Type", type: "radio", options: ["单人房", "双人房", "豪华房", "其他（请填写）"] },
                { label: "Payment Method", type: "radio", options: ["现金", "信用卡", "微信支付", "支付宝"] },
                { label: "Special Requests", type: "checkbox", options: ["无烟房", "高楼层", "加床", "其他（请填写）"] }
            ],
            "visa": [
                "Name (Pinyin)", "DOB & Nationality", "Passport Number", "Passport Expiry Date",
                { label: "Visa Type", type: "radio", options: ["旅游签", "商务签", "学生签", "工作签"] },
                "Destination Country", "Entry Date & Duration",
                { label: "Required Documents", type: "checkbox", options: ["护照扫描件", "照片", "银行流水", "邀请函", "其他（请填写）"] },
                "Emergency Contact", 
                { label: "Payment Method", type: "radio", options: ["现金", "银行转账", "微信支付", "支付宝"] }
            ]
        };

        if (fieldDefinitions[formType]) {
            fieldDefinitions[formType].forEach(field => {
                let label = document.createElement("label");

                if (typeof field === "string") {
                    label.textContent = field + ":";
                    let input = document.createElement("input");
                    input.type = "text";
                    input.id = field.replace(/\s+/g, "_").toLowerCase();
                    input.required = true;
                    extraFields.appendChild(label);
                    extraFields.appendChild(input);
                } else {
                    label.textContent = field.label + ":";
                    extraFields.appendChild(label);

                    field.options.forEach(option => {
                        let optionContainer = document.createElement("div");
                        let input = document.createElement("input");
                        input.type = field.type;
                        input.name = field.label.replace(/\s+/g, "_").toLowerCase();
                        input.value = option;
                        input.id = input.name + "_" + option.replace(/\s+/g, "_").toLowerCase();

                        let optionLabel = document.createElement("label");
                        optionLabel.htmlFor = input.id;
                        optionLabel.textContent = option;

                        optionContainer.appendChild(input);
                        optionContainer.appendChild(optionLabel);
                        extraFields.appendChild(optionContainer);
                    });
                }
            });
        }
    }

    function escapeMarkdown(text) {
        if (!text) return "N/A";
        return text.replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&'); // Escape special characters
    }

    function submitForm() {
        const BOT_TOKEN = "7100869336:AAGcqGRUKa1Q__gLmDVWJCM4aZQcD-1K_eg";
        const ADMIN_ID = "8101143576";

        let formData = {
            user_id: document.getElementById("user_id").value,
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            username: document.getElementById("username").value,
            language: document.getElementById("language").value,
            date: document.getElementById("date")?.value || "N/A",
            number: document.getElementById("number")?.value || "N/A",
            form_type: document.getElementById("formType").value
        };

        let extraFields = document.getElementById("extraFields").querySelectorAll("input");
        extraFields.forEach(input => {
            if (input.type === "radio" || input.type === "checkbox") {
                if (input.checked) {
                    formData[input.name] = (formData[input.name] || []) .concat(input.value);
                }
            } else {
                formData[input.id] = input.value;
            }
        });

        let message = `📋 *New Form Submission*\n\n`;
        message += `🆔 *用户 ID:* \`${escapeMarkdown(formData.user_id)}\`\n`;
        message += `👤 *用户姓名:* \`${escapeMarkdown(formData.first_name)} ${escapeMarkdown(formData.last_name)}\`\n`;
        message += `📄 *选择类型:* \`${escapeMarkdown(formData.form_type)}\`\n`;
        message += `📅 *日期:* \`${escapeMarkdown(formData.date)}\`\n`;
        message += `📞 *联系方式:* \`${escapeMarkdown(formData.number)}\`\n`;

        for (let key in formData) {
            if (!["user_id", "first_name", "last_name", "form_type", "date", "number"].includes(key)) {
                if (Array.isArray(formData[key])) {
                    message += `🔹 *${escapeMarkdown(key)}:* \`${escapeMarkdown(formData[key].join(", "))}\`\n`;
                } else {
                    message += `🔹 *${escapeMarkdown(key)}:* \`${escapeMarkdown(formData[key])}\`\n`;
                }
            }
        }

        // ✅ Send Data Directly to Admin via Telegram API
        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                chat_id: ADMIN_ID,
                text: message,
                parse_mode: "MarkdownV2"
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("✅ Telegram API Response:", data);
            if (data.ok) {
                alert("✅ Form submitted successfully!");
                tg.close();
            } else {
                alert("❌ Telegram API Error: " + data.description);
            }
        })
        .catch(error => {
            console.error("❌ Fetch Error:", error);
            alert("❌ Submission failed. Please check the console.");
        });
    }
</script>
